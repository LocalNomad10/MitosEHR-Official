\hypertarget{classdb_helper}{\section{db\-Helper \-Class \-Reference}
\label{classdb_helper}\index{db\-Helper@{db\-Helper}}
}
\-Inheritance diagram for db\-Helper\-:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=12.000000cm]{classdb_helper}
\end{center}
\end{figure}
\subsection*{\-Public \-Member \-Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classdb_helper_a095c5d389db211932136b53f25f39685}{\-\_\-\-\_\-construct} ()
\item 
\hyperlink{classdb_helper_afab91f6d05df61aa06e6bfc035b13afe}{filert\-By\-Start\-Limit} (\$rows, \$params)
\item 
\hyperlink{classdb_helper_a21e387f778abae898a33b0355e56c095}{set\-S\-Q\-L} (\$sql)
\item 
\hyperlink{classdb_helper_a43a2fa1fe095e37df5a641fe1cfc7d9c}{exec\-Statement} (\$fetch\-Style=\-P\-D\-O\-::\-F\-E\-T\-C\-H\-\_\-\-B\-O\-T\-H)
\item 
\hyperlink{classdb_helper_ae033db35138ae80f3b1fd33c5c2c473e}{exec\-Only} ()
\item 
\hyperlink{classdb_helper_aa9840bbfb81d2d519994cd0a8e880c4a}{sql\-Bind} (\$b\-\_\-array, \$table, \$iu=\char`\"{}\-I\char`\"{}, \$where)
\item 
\hyperlink{classdb_helper_a75dea4073687142b0b1b6a6819cbb243}{exec\-Log} ()
\item 
\hyperlink{classdb_helper_ac1876160b600b359a60fd5aad7edba09}{exec\-Event} (\$event\-Log)
\item 
\hyperlink{classdb_helper_ae48cc10bd727774bb36203986ce3b176}{fetch} ()
\item 
\hyperlink{classdb_helper_a24ada5decce3d1b79cd82f5a90ccf404}{get\-Error} ()
\item 
\hyperlink{classdb_helper_a82b073888555fc72e57142fe913db377}{row\-Count} ()
\end{DoxyCompactItemize}
\subsection*{\-Data \-Fields}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classdb_helper_a29c1e591b4e284bca5ae38ed00eea5a9}{\$sql\-\_\-statement}
\item 
\hyperlink{classdb_helper_ae4ac788f919cb92f528ab1455e8a3e6b}{\$last\-Insert\-Id}
\end{DoxyCompactItemize}


\subsection{\-Detailed \-Description}


\-Definition at line 38 of file db\-Helper.\-php.



\subsection{\-Constructor \& \-Destructor \-Documentation}
\hypertarget{classdb_helper_a095c5d389db211932136b53f25f39685}{\index{db\-Helper@{db\-Helper}!\-\_\-\-\_\-construct@{\-\_\-\-\_\-construct}}
\index{\-\_\-\-\_\-construct@{\-\_\-\-\_\-construct}!dbHelper@{db\-Helper}}
\subsubsection[{\-\_\-\-\_\-construct}]{\setlength{\rightskip}{0pt plus 5cm}{\bf \-\_\-\-\_\-construct} (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classdb_helper_a095c5d389db211932136b53f25f39685}
\-Connect to the database \$db = new \$db\-Helper();

\-Author\-: \-G\-I \-Technologies, 2011 

\-Definition at line 52 of file db\-Helper.\-php.


\begin{DoxyCode}
                               {
                error_reporting(0);
                try {
                $this->conn = new PDO( "mysql:host=" . $_SESSION['site']['db'][
      'host'] . ";port=" . $_SESSION['site']['db']['port'] . ";dbname=" . $_SESSION['
      site']['db']['database'], $_SESSION['site']['db']['username'], $_SESSION['site'][
      'db']['password'] );
                } catch (PDOException $e) {
                $this->err = $e->getMessage();
                }
        }
\end{DoxyCode}


\subsection{\-Member \-Function \-Documentation}
\hypertarget{classdb_helper_ac1876160b600b359a60fd5aad7edba09}{\index{db\-Helper@{db\-Helper}!exec\-Event@{exec\-Event}}
\index{exec\-Event@{exec\-Event}!dbHelper@{db\-Helper}}
\subsubsection[{exec\-Event}]{\setlength{\rightskip}{0pt plus 5cm}{\bf exec\-Event} (
\begin{DoxyParamCaption}
\item[{\$}]{event\-Log}
\end{DoxyParamCaption}
)}}\label{classdb_helper_ac1876160b600b359a60fd5aad7edba09}
\-Inject directly to the \-L\-O\-G \$db\-Helper-\/$>$exec\-Event(\char`\"{}\-Need to be audited!\char`\"{}); return\-: \-N/\-A

\-Author\-: \-G\-I \-Technologies, 2011


\begin{DoxyParams}{\-Parameters}
{\em \$event\-Log} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
array 
\end{DoxyReturn}


\-Definition at line 270 of file db\-Helper.\-php.


\begin{DoxyCode}
                                     {
        
                // Prepare the SQL statement first, and then execute.
                $stmt = $this->conn->prepare("INSERT INTO log (date, event,
       comments, user, patient_id) VALUES (:dtime, :event, :comments, :user, :patient_id)"
      );
                $stmt->bindParam(':dtime', date('Y-m-d H:i:s'), PDO::PARAM_STR)
      ;
                $stmt->bindParam(':event', $eventLog, PDO::PARAM_STR);
                $stmt->bindParam(':comments', $this->sql_statement, 
      PDO::PARAM_STR);
                $stmt->bindParam(':user', $_SESSION['user']['name'], 
      PDO::PARAM_STR);
                $stmt->bindParam(':patient_id', $_SESSION['patient']['id'], 
      PDO::PARAM_INT);
                $stmt->execute();
                return $this->conn->errorInfo();
        }
\end{DoxyCode}
\hypertarget{classdb_helper_a75dea4073687142b0b1b6a6819cbb243}{\index{db\-Helper@{db\-Helper}!exec\-Log@{exec\-Log}}
\index{exec\-Log@{exec\-Log}!dbHelper@{db\-Helper}}
\subsubsection[{exec\-Log}]{\setlength{\rightskip}{0pt plus 5cm}{\bf exec\-Log} (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classdb_helper_a75dea4073687142b0b1b6a6819cbb243}
\-Simple \-S\-Q\-L \-Statement, with \-Event \-L\-O\-G injection \$db\-Helper-\/$>$exe\-Log(); return\-: \-Array of records + \-Inject the action on the event log \-The \-Log \-Injection is automatic \-It tries to detect an insert, delete, alter and log the event

\-Author\-: \-G\-I \-Technologies, 2011

\begin{DoxyReturn}{\-Returns}
array 
\end{DoxyReturn}
\-Execute the sql statement

\-If the \-Q\-U\-E\-R\-Y has \-I\-N\-S\-E\-R\-T, \-D\-E\-L\-E\-T\-E, \-A\-L\-T\-E\-R then has to insert the event to the database.

\-Check up the last insert id.

\-Prepare the \-S\-Q\-L statement first, and then execute.

\-Definition at line 216 of file db\-Helper.\-php.


\begin{DoxyCode}
                          {
                
                $this->conn->query( $this->sql_statement );

                if (stristr($this->sql_statement, "INSERT") ||
                        stristr($this->sql_statement, "DELETE") ||
                        stristr($this->sql_statement, "UPDATE") || 
                        stristr($this->sql_statement, "ALTER")){
                                
                                $this->lastInsertId = $this->conn->lastInsertId
      ();
                                
                        if (stristr($this->sql_statement, "INSERT")) { 
      $eventLog = "Record insertion"; }
                        if (stristr($this->sql_statement, "DELETE")) $eventLog 
      = "Record deletion";
                        if (stristr($this->sql_statement, "UPDATE")) $eventLog 
      = "Record update";
                        if (stristr($this->sql_statement, "ALTER")) $eventLog =
       "Table alteration";
            $sql = "INSERT INTO log (date, facility, event, comments, user,
       patient_id, checksum)
                        VALUES (:dtime, :facility, :event, :comments, :user,
       :patient_id, :checksum)";
                        $stmt = $this->conn->prepare($sql);
                        $stmt->bindParam(':dtime', date('Y-m-d H:i:s'), 
      PDO::PARAM_STR);
            $stmt->bindParam(':event', $eventLog, PDO::PARAM_STR);
                        $stmt->bindParam(':comments', $this->sql_statement, 
      PDO::PARAM_STR);
                        $stmt->bindParam(':user', $_SESSION['user']['name'], 
      PDO::PARAM_STR);
                        $stmt->bindParam(':checksum', crc32($this->
      sql_statement), PDO::PARAM_STR);
                        $stmt->bindParam(':facility', $_SESSION['site']['
      facility'], PDO::PARAM_STR);
                        $stmt->bindParam(':patient_id', $_SESSION['patient']['
      id'], PDO::PARAM_INT);
                        $stmt->execute();
                }
                return $this->conn->errorInfo();
        }
\end{DoxyCode}
\hypertarget{classdb_helper_ae033db35138ae80f3b1fd33c5c2c473e}{\index{db\-Helper@{db\-Helper}!exec\-Only@{exec\-Only}}
\index{exec\-Only@{exec\-Only}!dbHelper@{db\-Helper}}
\subsubsection[{exec\-Only}]{\setlength{\rightskip}{0pt plus 5cm}{\bf exec\-Only} (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classdb_helper_ae033db35138ae80f3b1fd33c5c2c473e}
\-Simple exec \-S\-Q\-L \-Statement, with no \-Event \-L\-O\-G injection return\-: \-Array of errors, if any.

\-Author\-: \-G\-I \-Technologies, 2011

\begin{DoxyReturn}{\-Returns}
array 
\end{DoxyReturn}


\-Definition at line 135 of file db\-Helper.\-php.


\begin{DoxyCode}
                           {
        $this->conn->query($this->sql_statement);
                if (stristr($this->sql_statement, "SELECT")){
                        $this->lastInsertId = $this->conn->lastInsertId();
                }
                return $this->conn->errorInfo();
        }
\end{DoxyCode}
\hypertarget{classdb_helper_a43a2fa1fe095e37df5a641fe1cfc7d9c}{\index{db\-Helper@{db\-Helper}!exec\-Statement@{exec\-Statement}}
\index{exec\-Statement@{exec\-Statement}!dbHelper@{db\-Helper}}
\subsubsection[{exec\-Statement}]{\setlength{\rightskip}{0pt plus 5cm}{\bf exec\-Statement} (
\begin{DoxyParamCaption}
\item[{\$}]{fetch\-Style = {\ttfamily \-P\-D\-O\-:\-:\-F\-E\-T\-C\-H\-\_\-\-B\-O\-T\-H}}
\end{DoxyParamCaption}
)}}\label{classdb_helper_a43a2fa1fe095e37df5a641fe1cfc7d9c}
\-Simple \-S\-Q\-L \-Statement, with no \-Event \-L\-O\-G injection \$db\-Helper-\/$>$\hyperlink{classdb_helper_a43a2fa1fe095e37df5a641fe1cfc7d9c}{exec\-Statement()}; return\-: \-Array of records, if error occurred return the error instead foreach (sql\-Statement(\$sql) as \$urow) \{

\-Author\-: \-G\-I \-Technologies, 2011


\begin{DoxyParams}[1]{\-Parameters}
int & {\em \$fetch\-Style} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
array 
\end{DoxyReturn}


\-Definition at line 113 of file db\-Helper.\-php.


\begin{DoxyCode}
                                                           {
                $recordset = $this->conn->query($this->sql_statement);
                if (stristr($this->sql_statement, "SELECT")){
                        $this->lastInsertId = $this->conn->lastInsertId();
                }
                $err = $this->conn->errorInfo();
                if(!$err[2]){
                        return $recordset->fetchAll($fetchStyle);
                } else {
                        return $err;
                }
        }
\end{DoxyCode}
\hypertarget{classdb_helper_ae48cc10bd727774bb36203986ce3b176}{\index{db\-Helper@{db\-Helper}!fetch@{fetch}}
\index{fetch@{fetch}!dbHelper@{db\-Helper}}
\subsubsection[{fetch}]{\setlength{\rightskip}{0pt plus 5cm}{\bf fetch} (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classdb_helper_ae48cc10bd727774bb36203986ce3b176}
\-Fetch a recordset return\-: \-Only one record array \$rec = \$db\-Helper-\/$>$fetch(\$sql); if (\$rec\mbox{[}'username'\mbox{]} == \char`\"{}\char`\"{})\{

\-Author\-: \-G\-I \-Technologies, 2011

\begin{DoxyReturn}{\-Returns}
array$|$mixed 
\end{DoxyReturn}


\-Definition at line 294 of file db\-Helper.\-php.


\begin{DoxyCode}
                        {
                // Get all the records
                $recordset = $this->conn->query( $this->sql_statement );

        $err = $this->conn->errorInfo();

        if(!$err[2]){
            return $recordset->fetch(PDO::FETCH_ASSOC);
        } else {
            return $err;
        }

        }
\end{DoxyCode}
\hypertarget{classdb_helper_afab91f6d05df61aa06e6bfc035b13afe}{\index{db\-Helper@{db\-Helper}!filert\-By\-Start\-Limit@{filert\-By\-Start\-Limit}}
\index{filert\-By\-Start\-Limit@{filert\-By\-Start\-Limit}!dbHelper@{db\-Helper}}
\subsubsection[{filert\-By\-Start\-Limit}]{\setlength{\rightskip}{0pt plus 5cm}{\bf filert\-By\-Start\-Limit} (
\begin{DoxyParamCaption}
\item[{\$}]{rows, }
\item[{\$}]{params}
\end{DoxyParamCaption}
)}}\label{classdb_helper_afab91f6d05df61aa06e6bfc035b13afe}
\-Filter \-By \-Sart and \-Limit

\-This \-Function will filter the \$rows array by a start and \-Limit usin \-Lin\-Q.

{\ttfamily  function filert\-By\-Start\-Limit(\$rows, \$params)\{ \$result = from('\$row')-\/$>$in(\$rows)-\/$>$skip(\$params-\/$>$start) -\/$>$take(\$params-\/$>$limit) -\/$>$select('\$row'); return \$result; \} }


\begin{DoxyParams}{\-Parameters}
{\em \$rows} & \\
\hline
{\em \$params} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
mixed 
\end{DoxyReturn}


\-Definition at line 81 of file db\-Helper.\-php.


\begin{DoxyCode}
                                               {
        $result = from('$row')->in($rows)
                  ->skip($params->start)
                  ->take($params->limit)
                  ->select('$row');
        return $result;
    }
\end{DoxyCode}
\hypertarget{classdb_helper_a24ada5decce3d1b79cd82f5a90ccf404}{\index{db\-Helper@{db\-Helper}!get\-Error@{get\-Error}}
\index{get\-Error@{get\-Error}!dbHelper@{db\-Helper}}
\subsubsection[{get\-Error}]{\setlength{\rightskip}{0pt plus 5cm}{\bf get\-Error} (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classdb_helper_a24ada5decce3d1b79cd82f5a90ccf404}
\-Fetch the last error. get\-Error -\/ \-Get the error for a statement, if any.

return\-: \-If there was a problem with the connection it will return the error message, if the was not a connection problem, it will return a array with the code and message.

\-Author\-: \-G\-I \-Technologies, 2011

\begin{DoxyReturn}{\-Returns}
array$|$string 
\end{DoxyReturn}


\-Definition at line 321 of file db\-Helper.\-php.


\begin{DoxyCode}
                           {
                if (!$this->err){
                        return $this->conn->errorInfo();
                } else {
                        return $this->err;
                }
        }
\end{DoxyCode}
\hypertarget{classdb_helper_a82b073888555fc72e57142fe913db377}{\index{db\-Helper@{db\-Helper}!row\-Count@{row\-Count}}
\index{row\-Count@{row\-Count}!dbHelper@{db\-Helper}}
\subsubsection[{row\-Count}]{\setlength{\rightskip}{0pt plus 5cm}{\bf row\-Count} (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classdb_helper_a82b073888555fc72e57142fe913db377}
row\-Count return\-: \-The number of rows in a table \$rec = \$db\-Helper-\/$>$\hyperlink{classdb_helper_a82b073888555fc72e57142fe913db377}{row\-Count()}; if (\$rec\mbox{[}'username'\mbox{]} == \char`\"{}\char`\"{})

\-Author\-: \-Ernesto \-Rodriguez

\begin{DoxyReturn}{\-Returns}
int 
\end{DoxyReturn}


\-Definition at line 340 of file db\-Helper.\-php.


\begin{DoxyCode}
                           {
        
                // Get all the records & count it.
                $recordset = $this->conn->query( $this->sql_statement );
                return $recordset->rowCount();
                
        }
\end{DoxyCode}
\hypertarget{classdb_helper_a21e387f778abae898a33b0355e56c095}{\index{db\-Helper@{db\-Helper}!set\-S\-Q\-L@{set\-S\-Q\-L}}
\index{set\-S\-Q\-L@{set\-S\-Q\-L}!dbHelper@{db\-Helper}}
\subsubsection[{set\-S\-Q\-L}]{\setlength{\rightskip}{0pt plus 5cm}{\bf set\-S\-Q\-L} (
\begin{DoxyParamCaption}
\item[{\$}]{sql}
\end{DoxyParamCaption}
)}}\label{classdb_helper_a21e387f778abae898a33b0355e56c095}
\-Set the \-S\-Q\-L \-Statement

\-Author\-: \-G\-I \-Technologies, 2011


\begin{DoxyParams}{\-Parameters}
{\em \$sql} & \\
\hline
\end{DoxyParams}


\-Definition at line 97 of file db\-Helper.\-php.


\begin{DoxyCode}
                             {
                $this->sql_statement = $sql;
        }
\end{DoxyCode}
\hypertarget{classdb_helper_aa9840bbfb81d2d519994cd0a8e880c4a}{\index{db\-Helper@{db\-Helper}!sql\-Bind@{sql\-Bind}}
\index{sql\-Bind@{sql\-Bind}!dbHelper@{db\-Helper}}
\subsubsection[{sql\-Bind}]{\setlength{\rightskip}{0pt plus 5cm}{\bf sql\-Bind} (
\begin{DoxyParamCaption}
\item[{\$}]{b\-\_\-array, }
\item[{\$}]{table, }
\item[{\$}]{iu = {\ttfamily \char`\"{}\-I\char`\"{}}, }
\item[{\$}]{where}
\end{DoxyParamCaption}
)}}\label{classdb_helper_aa9840bbfb81d2d519994cd0a8e880c4a}
sql\-Bind \-This function builds a \-S\-Q\-L \-Statement based on an array arguments to pass\-:

\$b\-\_\-array -\/ \-An array containing a key that has to be the exact field on the data base, and it's value

table -\/ \-A valid database table to make the \-S\-Q\-L statement

\$iu -\/ \-Insert or \-Update parameter. \-This has to options i = \-Insert, u = \-Update

\$where -\/ \-If in \$iu = \-U is used you must pass a \-W\-H\-E\-R\-E clause in the last parameter. ie\-: id='1', list\-\_\-id='patient'

\-N\-O\-T\-E\-: \-To eliminate fields that are not in the database you can use unset(\$b\-\_\-array\mbox{[}'field'\mbox{]});


\begin{DoxyParams}[1]{\-Parameters}
 & {\em \$b\-\_\-array} & \\
\hline
 & {\em \$table} & \\
\hline
string & {\em \$iu} & \\
\hline
 & {\em \$where} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
string 
\end{DoxyReturn}
\-Step 1 \-Create the \-I\-N\-S\-E\-R\-T or \-U\-P\-D\-A\-T\-E \-Clause

\-Step 2 \-Create the \-S\-E\-T clause

\-Step 3 \-Create the \-W\-H\-E\-R\-E clause, if applicable

\-Definition at line 168 of file db\-Helper.\-php.


\begin{DoxyCode}
                                                           {

        unset($b_array['__utma'],$b_array['__utmz'],$b_array['MitosEHR']);

        $sql_r = '';
                $iu = strtolower($iu);
                if ($iu == "i"){
                        $sql_r = "INSERT INTO " . $table;
                } elseif($iu == "u"){
                        $sql_r = "UPDATE " . $table;
                }
                $sql_r .= " SET ";
                foreach($b_array as $key => $value){
                        if($where <> ($key . "='" . addslashes($value) . "'") 
      &&
                                $where <> ($key . "=" . addslashes($value)) &&
                                $where <> ($key . '="' . addslashes($value) . 
      '"')){
                                $sql_r .= $key . "='" . trim(addslashes($value)
      ) . "', "; 
                        }
                }
                $sql_r = substr($sql_r, 0, -2);
                if ($iu == "u"){ $sql_r .= " WHERE " . $where; }
                return $sql_r;
        }
\end{DoxyCode}


\subsection{\-Field \-Documentation}
\hypertarget{classdb_helper_ae4ac788f919cb92f528ab1455e8a3e6b}{\index{db\-Helper@{db\-Helper}!\$last\-Insert\-Id@{\$last\-Insert\-Id}}
\index{\$last\-Insert\-Id@{\$last\-Insert\-Id}!dbHelper@{db\-Helper}}
\subsubsection[{\$last\-Insert\-Id}]{\setlength{\rightskip}{0pt plus 5cm}\$last\-Insert\-Id}}\label{classdb_helper_ae4ac788f919cb92f528ab1455e8a3e6b}


\-Definition at line 43 of file db\-Helper.\-php.

\hypertarget{classdb_helper_a29c1e591b4e284bca5ae38ed00eea5a9}{\index{db\-Helper@{db\-Helper}!\$sql\-\_\-statement@{\$sql\-\_\-statement}}
\index{\$sql\-\_\-statement@{\$sql\-\_\-statement}!dbHelper@{db\-Helper}}
\subsubsection[{\$sql\-\_\-statement}]{\setlength{\rightskip}{0pt plus 5cm}\$sql\-\_\-statement}}\label{classdb_helper_a29c1e591b4e284bca5ae38ed00eea5a9}


\-Definition at line 40 of file db\-Helper.\-php.



\-The documentation for this class was generated from the following file\-:\begin{DoxyCompactItemize}
\item 
\-C\-:/wamp/www/\-Mitos\-E\-H\-R/classes/\hyperlink{db_helper_8php}{db\-Helper.\-php}\end{DoxyCompactItemize}
